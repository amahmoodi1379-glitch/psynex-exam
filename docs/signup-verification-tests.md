# راهنمای تست جریان جدید ثبت‌نام

این سناریوها برای بررسی جریان جدید ثبت‌نام با تأیید ایمیل طراحی شده‌اند. برای هر سناریو فرض بر این است که سرویس در حالت توسعه اجرا می‌شود و دسترسی به کنسول لاگ‌ها یا رابط Wrangler برای بازرسی مقادیر KV دارید.

## ۱. جلوگیری از ثبت‌نام جعلی (ایمیل نامعتبر یا تکراری)
1. درخواست `POST /api/auth/signup` را با بدنه `{ "email": "attacker@example.com" }` ارسال کنید.
2. پاسخ باید با کد 400 و خطای `only_gmail_allowed` برگردد.
3. همان درخواست را با ایمیل Gmail موجود در سامانهٔ فعال (`student@gmail.com`) ارسال کنید.
4. پاسخ باید با کد 400 و خطای `email_exists` یا `account_disabled` (بسته به وضعیت فعلی) برگردد و هیچ کد جدیدی تولید نشود.

## ۲. آغاز ثبت‌نام جدید
1. درخواست `POST /api/auth/signup` را با بدنه `{ "email": "new.user@gmail.com" }` ارسال کنید.
2. وضعیت پاسخ باید 200 باشد و بدنه شامل `{"ok":true,"step":"verify"}` باشد.
3. با استفاده از `wrangler kv:key get signup:challenge:new.user@gmail.com` (یا بررسی لاگ‌ Worker) مقدار کد ارسال‌شده را پیدا کنید. در محیط توسعه، کد در لاگ با الگوی `[signup] verification code for ...` چاپ می‌شود.
4. کاربر جدید را با `wrangler kv:key get user:new.user@gmail.com` بررسی کنید؛ مقدار `status` باید `"pending"` باشد.

## ۳. بررسی رفتار در برابر کد اشتباه
1. درخواست `POST /api/auth/signup/verify` را با بدنه `{ "email": "new.user@gmail.com", "code": "000000", "password": "Password123", "r": "/student" }` ارسال کنید.
2. پاسخ باید 400 و خطای `invalid_code` (یا پس از 5 تلاش ناموفق، `too_many_attempts`) باشد و وضعیت کاربر همچنان `pending` باقی بماند.

## ۴. تکمیل موفق ثبت‌نام
1. همان درخواست مرحلهٔ قبل را این بار با کد صحیح بازیابی‌شده و رمزی با حداقل ۸ کاراکتر ارسال کنید.
2. پاسخ باید 200، `Set-Cookie` حاوی نشست و فیلد `to` با مسیر هدایت باشد.
3. مقدار کاربر در KV را دوباره بررسی کنید؛ `status` باید `"active"` و هش پسورد تنظیم شده باشد.
4. با درخواست `POST /api/auth/login` (همان ایمیل و رمز) بررسی کنید که خطایی مبنی بر `pending_verification` دریافت نمی‌شود و ورود موفق است.

> نکته: در صورت نیاز به ارسال دوبارهٔ کد، بین درخواست‌ها حداقل یک دقیقه صبر کنید؛ سامانه به‌صورت داخلی نرخ ارسال مجدد را محدود می‌کند.
